<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script src="js/jquery-1.12.0.js"></script>
<script>
  //判断浏览器是否支持HTML5 Canvas
  $(document).ready(function(){
	  if (!HTMLCanvasElement.prototype.toBlob) {
		  Object.defineProperty(HTMLCanvasElement.prototype, 'toBlob', {
		   value: function (callback, type, quality) {

		     var binStr = atob( this.toDataURL(type, quality).split(',')[1] ),
		         len = binStr.length,
		         arr = new Uint8Array(len);

		     for (var i=0; i<len; i++ ) {
		      arr[i] = binStr.charCodeAt(i);
		     }

		     callback( new Blob( [arr], {type: type || 'image/png'} ) );
		   }
		  });
		 }
	  
  });
  $(document).ready( function () {            
   var canvas = document.getElementById("canvas");         
   var  context = canvas.getContext("2d");     
   var  webcam = document.getElementById("webcam");
   var videoObj = {video: true };             
   var   errBack = function (error) {           
            console.log("Video capture error: ", error.code);    
               }; 
               navigator.getMedia = ( navigator.getUserMedia ||
                       navigator.webkitGetUserMedia ||
                       navigator.mozGetUserMedia ||
                       navigator.msGetUserMedia);
               navigator.getMedia(videoObj, function (stream) {
	   if (window.URL) {
	        webcam.src = window.URL.createObjectURL(stream);
	    } else {
	        webcam.src = stream;
	    }
	   webcam.play();
             }, errBack);           
         
            
      //这个是拍照按钮的事件，          
     $("#snap").click(function () {          
         context.drawImage(webcam, 0, 0, 640, 640);     
              //CatchCode();    
         var imgData = canvas.toDataURL("image/png"); 
         var blob2=canvas.toBlob(function(b){
        	   var ws=new WebSocket("ws://localhost:8080/wstest/image/node1");
               ws.onopen = function()
      			{	
      				 var temper=$("#temperature").val();
      				  console.log("open");
      				  ws.send("2016/02/01 12:22:22:001")
      				  ws.send(b);
      			};
      				ws.onmessage = function(evt)
      				{
      				  console.log(evt.data)
      				};
      				ws.onclose = function(evt)
      				{
      				  console.log("WebSocketClosed!");
      				};
      				ws.onerror = function(evt)
      				{
      				  console.log("WebSocketError!");
      				};
        	 
         },"image/jpeg", 0.95);
   
         var blob=new Blob([imgData.substr(22)]);
  
      
    });           
          }, false);           
          //定时器         
 // var interval = setInterval(CatchCode, "300");      
                         //这个是 刷新上 图像的        
   function CatchCode() {        
       $("#snap").click();
//实际运用可不写，测试代 ， 为单击拍照按钮就获取了当前图像，有其他用途    
           var canvans = document.getElementById("canvas"); 
//获取浏览器页面的画布对象                       
   //以下开始编 数据   
   
                                  var imgData = canvans.toDataURL(); 
                                 
//将图像转换为base64数据
               var base64Data = imgData.substr(22); 
//在前端截取22位之后的字符串作为图像数据       
                            //开始异步上             
   $.post("uploadImgCode.ashx", { "img": base64Data }, function (data, status) {      
             if (status == "success") {                 
      if (data == "OK") {                
           alert("二维 已经解析");                   
    }                    
   else {              
             // alert(data);          
             }          
         }     
              else {   
                    alert("数据上 失败");                 
  }               }, "text");           
          }      
 </script>
</head>
<body>
	<div id="contentHolder">
		<video id="webcam"  width="640" height="640">
		</video>
		<button id="snap">拍照</button>
		<canvas id="canvas" width="1200" height="1200">
</canvas>
	</div>
	<div id="support"></div>
</body>
</html>